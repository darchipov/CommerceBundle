define(["jquery","ekyna-modal","ekyna-dispatcher","jquery/form"],function(a,b,c){"use strict";function d(){e&&e.abort(),g.loadingSpinner(),e=a.ajax({url:g.data("refresh-url"),dataType:"xml",cache:!1}),e.done(function(a){l(a),g.loadingSpinner("off")}),e.fail(function(){console.log("Failed to update cart checkout content.")})}var e,f={information:".cart-checkout-information","invoice-address":".cart-checkout-invoice-address","delivery-address":".cart-checkout-delivery-address",comment:".cart-checkout-comment",attachments:".cart-checkout-attachments"},g=a(".cart-checkout"),h=g.find(".cart-checkout-customer"),i=g.find(".cart-checkout-forms"),j=g.find(".cart-checkout-submit"),k=function(b){var c=a(b).find("view");1===c.size()&&(1===parseInt(c.attr("empty"))?(i.slideUp(),h.slideUp(),j.slideUp()):(i.show().slideDown(),1===parseInt(c.attr("customer"))?h.slideUp():h.show().slideDown(),1===parseInt(c.attr("valid"))?j.show().slideDown():j.slideUp()))},l=function(b){var c=a(b);for(var d in f)if(f.hasOwnProperty(d)){var e=c.find(d);1===e.size()&&a(f[d]).html(e.text())}k(b);var g=c.find("view");return 1===g.size()&&(a(".sale-view").replaceWith(a(g.text())),!0)};c.on("ekyna_commerce.sale_view_response",function(a){k(a)}),c.on("ekyna_user.user_status",function(a){a.authenticated&&(d(),h.slideUp())}),a(document).on("click",".cart-checkout [data-cart-modal]",function(c){c.preventDefault();var d=a(this),e=new b;return e.load({url:d.attr("href")}),a(e).on("ekyna.modal.response",function(a){"xml"===a.contentType&&l(a.content)&&(a.preventDefault(),e.close())}),!1}),a(document).on("click",".cart-checkout [data-cart-xhr]",function(b){b.preventDefault();var c=a(this),d=c.data("confirm");if(d&&d.length&&!confirm(d))return!1;var e=a.ajax({url:a(this).attr("href"),method:"post",dataType:"xml"});return e.done(function(a){l(a)}),!1})});