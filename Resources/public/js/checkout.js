define(["jquery","ekyna-modal","ekyna-dispatcher","jquery/form"],function(a,b,c){"use strict";function d(){e&&e.abort(),h.loadingSpinner(),e=a.ajax({url:h.data("refresh-url"),dataType:"xml",cache:!1}),e.done(function(a){g(a),h.loadingSpinner("off")}),e.fail(function(){console.log("Failed to update cart checkout content.")})}var e,f={information:".cart-checkout-information","invoice-address":".cart-checkout-invoice-address","delivery-address":".cart-checkout-delivery-address",comment:".cart-checkout-comment",attachments:".cart-checkout-attachments"},g=function(b){var c=a(b);for(var d in f)if(f.hasOwnProperty(d)){var e=c.find(d);1===e.size()&&a(f[d]).html(e.text())}var g=c.find("view");return 1===g.size()&&(1===parseInt(g.attr("empty"))?(j.slideUp(),i.slideUp(),k.slideUp()):(j.show().slideDown(),1===parseInt(g.attr("customer"))?i.slideUp():i.show().slideDown(),1===parseInt(g.attr("valid"))?k.show().slideDown():k.slideUp()),a(".sale-view").replaceWith(a(g.text())),!0)},h=a(".cart-checkout"),i=h.find(".cart-checkout-customer"),j=h.find(".cart-checkout-forms"),k=h.find(".cart-checkout-submit");c.on("ekyna_user.user_status",function(a){a.authenticated&&(d(),i.slideUp())}),a(document).on("click",".cart-checkout [data-cart-modal]",function(c){c.preventDefault();var d=a(this),e=new b;return e.load({url:d.attr("href")}),a(e).on("ekyna.modal.response",function(a){"xml"===a.contentType&&g(a.content)&&(a.preventDefault(),e.close())}),!1}),a(document).on("click",".cart-checkout [data-cart-xhr]",function(b){b.preventDefault();var c=a(this),d=c.data("confirm");if(d&&d.length&&!confirm(d))return!1;var e=a.ajax({url:a(this).attr("href"),method:"post",dataType:"xml"});return e.done(function(a){g(a)}),!1})});